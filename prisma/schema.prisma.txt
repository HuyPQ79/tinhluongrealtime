// Cấu hình kết nối Database
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- MÔ HÌNH NGƯỜI DÙNG & NHÂN SỰ ---
model User {
  id                  String   @id // Mã nhân viên (ví dụ: NV001)
  username            String   @unique
  password            String
  name                String
  avatar              String?
  email               String?
  phone               String?
  joinDate            String
  status              String   // ACTIVE, INACTIVE, PROBATION, PENDING_APPROVAL
  roles               Json     // Lưu mảng các quyền: ["ADMIN", "NHAN_SU"]
  numberOfDependents  Int      @default(0)
  
  // Thông tin bổ nhiệm hiện tại
  currentDeptId       String?
  currentPosition     String?
  currentRankId       String?
  currentGradeId      String?
  currentStartDate    String?
  
  // Cấu hình lương
  paymentType         String   @default("TIME") // TIME hoặc PIECEWORK
  efficiencySalary    Float    @default(0)      // Lương HQ định mức
  pieceworkUnitPrice  Float    @default(0)      // Đơn giá khoán
  reservedBonusAmount Float    @default(0)      // Thưởng treo năm
  probationRate       Float    @default(100)    // % Lương thử việc

  // Quan hệ
  assignedDeptIds     Json?    // Các phòng ban quản lý (cho Manager/Kế toán)
  attendance          AttendanceRecord[]
  salaryRecords       SalaryRecord[]
  evaluations         EvaluationRequest[]
}

// --- MÔ HÌNH PHÒNG BAN ---
model Department {
  id              String  @id
  name            String
  blockDirectorId String?
  managerId       String?
  hrId            String?
  budgetNorm      Float   @default(0)
}

// --- MÔ HÌNH CHẤM CÔNG HÀNG NGÀY ---
model AttendanceRecord {
  id                      String   @id
  userId                  String
  user                    User     @relation(fields: [userId], references: [id])
  date                    String   // Định dạng YYYY-MM-DD
  type                    String   // TIME, PIECEWORK, DAILY...
  hours                   Float    @default(8)
  overtimeHours           Float    @default(0)
  otRate                  Float    @default(1.5)
  isOvertimeWithOutput    Boolean  @default(false)
  output                  Float?   // Sản lượng nếu làm khoán
  pieceworkUnitPrice      Float?
  dailyWorkItemId         String?
  overtimeDailyWorkItemId String?
  status                  String   @default("DRAFT")
  notes                   String?
  sentToHrAt              DateTime?
  rejectionReason         String?
}

// --- MÔ HÌNH ĐÁNH GIÁ KPI & PHẠT ---
model EvaluationRequest {
  id             String   @id
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  userName       String
  criteriaId     String
  criteriaName   String
  scope          String   // MAIN_JOB, SIDE_JOB
  target         String   // MONTHLY_SALARY, RESERVED_BONUS
  type           String   // BONUS, PENALTY
  points         Float
  description    String?
  proofFileName  String?
  requesterId    String
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
  rejectionReason String?
}

// --- MÔ HÌNH BẢNG LƯƠNG THÁNG (SNAPSHOT) ---
model SalaryRecord {
  id                 String @id
  userId             String
  user               User   @relation(fields: [userId], references: [id])
  userName           String
  date               String // Định dạng YYYY-MM
  status             String
  
  // Các biến số tính toán
  actualBaseSalary   Float
  actualEfficiencySalary Float
  actualPieceworkSalary  Float
  otherSalary        Float
  totalAllowance     Float
  totalBonus         Float
  overtimeSalary     Float
  
  // Khấu trừ
  insuranceDeduction Float
  pitDeduction       Float
  unionFee           Float
  advancePayment     Float
  otherDeductions    Float
  
  // Kết quả cuối
  netSalary          Float
  calculationLog     String? @db.LongText // Lưu JSON chi tiết cách tính
  adjustments        Json?                // Các khoản điều chỉnh tay
  lastUpdated        DateTime @default(now())
}

// --- CẤU HÌNH HỆ THỐNG ---
model SystemConfig {
  id                 Int     @id @default(1)
  isPeriodLocked     Boolean @default(false)
  approvalMode       String  @default("POST_AUDIT")
  personalRelief     Float   @default(11000000)
  dependentRelief    Float   @default(4400000)
  insuranceRate      Float   @default(10.5)
  unionFeeRate       Float   @default(1)
  maxInsuranceBase   Float   @default(36000000)
  approvalWorkflow   Json?   // Cấu hình các bước duyệt động
}

// --- NHẬT KÝ HỆ THỐNG ---
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  actor     String
  timestamp DateTime @default(now())
  details   String   @db.Text
}