// C?u hình k?t n?i Database
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- MÔ HÌNH NGU?I DÙNG & NHÂN S? ---
model User {
  id                  String   @id // Mã nhân viên (ví d?: NV001)
  username            String   @unique
  password            String
  name                String
  avatar              String?
  email               String?
  phone               String?
  joinDate            String
  status              String   // ACTIVE, INACTIVE, PROBATION, PENDING_APPROVAL
  roles               Json     // Luu m?ng các quy?n: ["ADMIN", "NHAN_SU"]
  numberOfDependents  Int      @default(0)
  
  // Thông tin b? nhi?m hi?n t?i
  currentDeptId       String?
  currentPosition     String?
  currentRankId       String?
  currentGradeId      String?
  currentStartDate    String?
  
  // C?u hình luong
  paymentType         String   @default("TIME") // TIME ho?c PIECEWORK
  efficiencySalary    Float    @default(0)      // Luong HQ d?nh m?c
  pieceworkUnitPrice  Float    @default(0)      // Ðon giá khoán
  reservedBonusAmount Float    @default(0)      // Thu?ng treo nam
  probationRate       Float    @default(100)    // % Luong th? vi?c

  // Quan h?
  assignedDeptIds     Json?    // Các phòng ban qu?n lý (cho Manager/K? toán)
  attendance          AttendanceRecord[]
  salaryRecords       SalaryRecord[]
  evaluations         EvaluationRequest[]
}

// --- MÔ HÌNH PHÒNG BAN ---
model Department {
  id              String  @id
  name            String
  blockDirectorId String?
  managerId       String?
  hrId            String?
  budgetNorm      Float   @default(0)
}

// --- MÔ HÌNH CH?M CÔNG HÀNG NGÀY ---
model AttendanceRecord {
  id                      String   @id
  userId                  String
  user                    User     @relation(fields: [userId], references: [id])
  date                    String   // Ð?nh d?ng YYYY-MM-DD
  type                    String   // TIME, PIECEWORK, DAILY...
  hours                   Float    @default(8)
  overtimeHours           Float    @default(0)
  otRate                  Float    @default(1.5)
  isOvertimeWithOutput    Boolean  @default(false)
  output                  Float?   // S?n lu?ng n?u làm khoán
  pieceworkUnitPrice      Float?
  dailyWorkItemId         String?
  overtimeDailyWorkItemId String?
  status                  String   @default("DRAFT")
  notes                   String?
  sentToHrAt              DateTime?
  rejectionReason         String?
}

// --- MÔ HÌNH ÐÁNH GIÁ KPI & PH?T ---
model EvaluationRequest {
  id             String   @id
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  userName       String
  criteriaId     String
  criteriaName   String
  scope          String   // MAIN_JOB, SIDE_JOB
  target         String   // MONTHLY_SALARY, RESERVED_BONUS
  type           String   // BONUS, PENALTY
  points         Float
  description    String?
  proofFileName  String?
  requesterId    String
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
  rejectionReason String?
}

// --- MÔ HÌNH B?NG LUONG THÁNG (SNAPSHOT) ---
model SalaryRecord {
  id                 String @id
  userId             String
  user               User   @relation(fields: [userId], references: [id])
  userName           String
  date               String // Ð?nh d?ng YYYY-MM
  status             String
  
  // Các bi?n s? tính toán
  actualBaseSalary   Float
  actualEfficiencySalary Float
  actualPieceworkSalary  Float
  otherSalary        Float
  totalAllowance     Float
  totalBonus         Float
  overtimeSalary     Float
  
  // Kh?u tr?
  insuranceDeduction Float
  pitDeduction       Float
  unionFee           Float
  advancePayment     Float
  otherDeductions    Float
  
  // K?t qu? cu?i
  netSalary          Float
  calculationLog     String? @db.LongText // Luu JSON chi ti?t cách tính
  adjustments        Json?                // Các kho?n di?u ch?nh tay
  lastUpdated        DateTime @default(now())
}

// --- C?U HÌNH H? TH?NG ---
model SystemConfig {
  id                 Int     @id @default(1)
  isPeriodLocked     Boolean @default(false)
  approvalMode       String  @default("POST_AUDIT")
  personalRelief     Float   @default(11000000)
  dependentRelief    Float   @default(4400000)
  insuranceRate      Float   @default(10.5)
  unionFeeRate       Float   @default(1)
  maxInsuranceBase   Float   @default(36000000)
  approvalWorkflow   Json?   // C?u hình các bu?c duy?t d?ng
}

// --- NH?T KÝ H? TH?NG ---
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  actor     String
  timestamp DateTime @default(now())
  details   String   @db.Text
}